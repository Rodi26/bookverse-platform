name: Release Platform to PROD

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Platform application version (SemVer) to release to PROD"
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Promote to PROD
        env:
          APPTRUST_BASE_URL: ${{ vars.APPTRUST_BASE_URL }}
          APPTRUST_ACCESS_TOKEN: ${{ secrets.APPTRUST_ACCESS_TOKEN }}
        run: |
          python - << 'PY'
          import os, sys, json, urllib.request
          base = os.environ["APPTRUST_BASE_URL"].rstrip('/')
          token = os.environ["APPTRUST_ACCESS_TOKEN"]
          app = "bookverse-platform"
          version = os.environ["INPUT_VERSION"] if "INPUT_VERSION" in os.environ else "${{ github.event.inputs.version }}"
          req = urllib.request.Request(
            url=f"{base}/applications/{app}/versions/{version}/promote",
            data=json.dumps({"target_stage": "PROD"}).encode('utf-8'),
            headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
            method="POST",
          )
          with urllib.request.urlopen(req, timeout=30) as resp:
            print(resp.read().decode('utf-8'))
          PY

      - name: Trigger Helm pinning in bookverse-helm
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository_owner }}/bookverse-helm
          event-type: platform_release
          client-payload: '{"platform_version": "${{ github.event.inputs.version }}"}'


