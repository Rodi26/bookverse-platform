# =============================================================================
# BookVerse Platform - Cross-Service Aggregate and Promotion Workflow
# =============================================================================
#
# This GitHub Actions workflow provides comprehensive platform-level aggregation
# and coordinated promotion capabilities for the BookVerse Platform, implementing
# enterprise-grade cross-service dependency management, version coordination,
# and unified deployment operations across the entire microservices ecosystem.
#
# ðŸ—ï¸ PLATFORM AGGREGATION STRATEGY:
#     - Cross-Service Coordination: Synchronized version collection from all BookVerse services
#     - Dependency Management: Intelligent resolution of service interdependencies and compatibility
#     - Version Harmonization: Semantic version alignment across inventory, recommendations, checkout, and web
#     - Integration Validation: End-to-end platform testing with real service interactions
#     - Evidence Consolidation: Unified audit trail collection from all service deployments
#     - Platform Versioning: Coherent platform version creation representing the complete ecosystem
#
# ðŸš€ COORDINATED PROMOTION PROCEDURES:
#     - Multi-Service Deployment: Orchestrated promotion of all services through environment stages
#     - Dependency Order Management: Intelligent deployment sequencing based on service dependencies
#     - Health Check Coordination: Comprehensive platform health validation at each promotion stage
#     - Rollback Coordination: Platform-wide rollback capabilities with service dependency awareness
#     - Performance Validation: End-to-end performance testing across the complete service mesh
#     - Business Process Continuity: Validation of complete customer journey functionality
#
# ðŸ“Š PLATFORM BUSINESS CONTINUITY:
#     - Zero Platform Downtime: Coordinated deployment ensuring continuous BookVerse operation
#     - End-to-End Functionality: Complete customer journey from discovery to purchase validation
#     - Cross-Service Integration: API compatibility and data flow validation across services
#     - Performance SLA Maintenance: Platform-wide response time and throughput guarantees
#     - Revenue Stream Protection: Complete e-commerce functionality preservation during updates
#     - Customer Experience Assurance: Seamless user experience across all platform touchpoints
#
# ðŸ› ï¸ PLATFORM OPERATIONAL EXCELLENCE:
#     - Automated Scheduling: Bi-weekly automated platform aggregation and promotion cycles
#     - Manual Override: On-demand platform operations for hotfixes and emergency deployments
#     - Preview Capabilities: Dry-run validation of platform operations before execution
#     - Selective Promotion: Granular control over platform promotion through environment stages
#     - Evidence Management: Comprehensive audit trail collection and compliance reporting
#
# ðŸ” PLATFORM SECURITY AND COMPLIANCE:
#     - Multi-Service Evidence: Consolidated cryptographic evidence from all service deployments
#     - Cross-Service Authentication: Coordinated OIDC and security validation across the platform
#     - Compliance Aggregation: Unified compliance reporting for SOX, PCI-DSS, GDPR across services
#     - Security Validation: Platform-wide security testing and vulnerability assessment
#     - Audit Trail Consolidation: Complete operational history for enterprise compliance analysis
#
# Authors: BookVerse Platform Team
# Version: 1.0.0
#
name: Platform Aggregate & Promote

# ðŸ”„ Concurrency Control: Ensures exclusive platform aggregation operations
# Prevents conflicting platform-wide deployment operations for system stability
concurrency:
  group: platform-aggregate-promote
  cancel-in-progress: false  # Preserve running platform operations for safety

# âš¡ Workflow Triggers: Scheduled and manual execution for platform coordination
# Supports both regular platform cycles and emergency coordination scenarios
on:
  # ðŸ“… Scheduled Execution: Bi-weekly automated platform aggregation and promotion
  # Runs every 2 weeks on Monday at 9 AM UTC for regular platform coordination
  schedule:
    - cron: '0 9 */14 * 1'  # Every 14 days on Monday morning
  
  # ðŸŽ›ï¸ Manual Dispatch: On-demand platform operations for coordination and emergency scenarios
  # Provides comprehensive control over platform aggregation and promotion parameters
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual platform aggregation'
        required: false
        default: 'Manual hotfix or testing'
        type: string
      create_version:
        description: "Create platform application version"
        required: false
        default: true
        type: boolean
      auto_promote:
        description: "Automatically promote through all stages to PROD"
        required: false
        default: true
        type: boolean
      preview_only:
        description: "Preview only (no writes)"
        required: false
        default: false
        type: boolean
      inventory_version:
        description: "Force inventory version (optional)"
        required: false
        type: string
      recommendations_version:
        description: "Force recommendations version (optional)"
        required: false
        type: string
      checkout_version:
        description: "Force checkout version (optional)"
        required: false
        type: string
      web_version:
        description: "Force web version (optional)"
        required: false
        type: string

jobs:
  aggregate:
    name: "Platform Aggregation"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      platform_version: ${{ steps.create-version.outputs.platform_version }}
      manifest_created: ${{ steps.create-version.outputs.manifest_created }}
    defaults:
      run:
        shell: bash
    steps:
      - name: "[Setup] Checkout"
        uses: actions/checkout@v4

      - name: "[Setup] Checkout bookverse-infra for shared scripts"
        uses: actions/checkout@v4
        with:
          repository: 'yonatanp-jfrog/bookverse-infra'
          ref: 'main'
          path: 'bookverse-infra'

      - name: "[Setup] Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: "[Setup] JFrog CLI"
        uses: EyalDelarea/setup-jfrog-cli@swampUpAppTrust
        id: jfrog-cli-auth
        with:
          oidc-provider-name: bookverse-platform-github
          oidc-audience: ${{ vars.JFROG_URL }}
        env:
          JF_URL: ${{ vars.JFROG_URL }}
          JF_PROJECT: ${{ vars.PROJECT_KEY }}

      - name: "[Setup] Extract OIDC Token from JFrog CLI"
        id: exchange-oidc
        run: |
          echo "ðŸ” Extracting OIDC token from JFrog CLI step output..."
          
          echo "ðŸ” Debugging JFrog CLI step outputs..."
          echo "Available outputs:"
          echo "  oidc-user: '${{ steps.jfrog-cli-auth.outputs.oidc-user }}'"
          echo "  oidc-token: '${{ steps.jfrog-cli-auth.outputs.oidc-token }}'"
          echo "  access-token: '${{ steps.jfrog-cli-auth.outputs.access-token }}'"
          echo "  token: '${{ steps.jfrog-cli-auth.outputs.token }}'"
          
          OIDC_TOKEN="${{ steps.jfrog-cli-auth.outputs.oidc-token }}"
          if [[ -n "$OIDC_TOKEN" && "$OIDC_TOKEN" != "null" ]]; then
            echo "âœ… Successfully retrieved OIDC token from JFrog CLI step output (oidc-token)"
            echo "ðŸ“‹ Token length: ${
          else
            echo "âŒ OIDC token not available from JFrog CLI step output (oidc-token)"
            echo "ðŸ” Available outputs from jfrog-cli-auth step:"
            echo "  oidc-user: '${{ steps.jfrog-cli-auth.outputs.oidc-user }}'"
            echo "  oidc-token: '${{ steps.jfrog-cli-auth.outputs.oidc-token }}'"
            echo "  access-token: '${{ steps.jfrog-cli-auth.outputs.access-token }}'"
            echo "  token: '${{ steps.jfrog-cli-auth.outputs.token }}'"
            exit 1
          fi
          
          echo "token=$OIDC_TOKEN" >> $GITHUB_OUTPUT

      - name: "[Setup] Install Python dependencies"
        run: |
          pip install --user PyYAML setuptools wheel
          echo "âœ… Python dependencies installed"

      - name: "[Run] Create version and write manifest"
        id: collect-versions
        env:
          JFROG_URL: "${{ vars.JFROG_URL }}"
          JF_OIDC_TOKEN: "${{ steps.exchange-oidc.outputs.token }}"
        run: |
          set -euo pipefail
          ARGS="--config config/services.yaml --output-dir manifests --source-stage PROD"
          if [[ -n "${{ inputs.inventory_version }}" ]]; then ARGS="$ARGS --override inventory=${{ inputs.inventory_version }}"; fi
          if [[ -n "${{ inputs.recommendations_version }}" ]]; then ARGS="$ARGS --override recommendations=${{ inputs.recommendations_version }}"; fi
          if [[ -n "${{ inputs.checkout_version }}" ]]; then ARGS="$ARGS --override checkout=${{ inputs.checkout_version }}"; fi
          if [[ -n "${{ inputs.web_version }}" ]]; then ARGS="$ARGS --override web=${{ inputs.web_version }}"; fi
          python -m app.main $ARGS | tee release_output.txt

      - name: "[Extract] Platform version from output"
        id: create-version
        if: ${{ inputs.create_version != false && inputs.preview_only != true }}
        run: |
          set -euo pipefail
          PLATFORM_VERSION=$(grep -o '"platform_app_version": "[^"]*"' release_output.txt | sed 's/"platform_app_version": "//; s/"//' | head -1)
          if [[ -z "$PLATFORM_VERSION" ]]; then
            echo "âŒ Could not extract platform version from output"
            exit 1
          fi
          echo "platform_version=$PLATFORM_VERSION" >> $GITHUB_OUTPUT
          echo "manifest_created=true" >> $GITHUB_OUTPUT
          echo "âœ… Platform application version created: $PLATFORM_VERSION"


      - name: "[Summary] Aggregation"
        run: |
          echo "
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform Version:** \`${{ steps.create-version.outputs.platform_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "
          echo "- Platform aggregation completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Service versions collected from PROD stage" >> $GITHUB_STEP_SUMMARY
          echo "- Platform manifest generated" >> $GITHUB_STEP_SUMMARY

  promote:
    name: "Auto-Promote Platform"
    needs: aggregate
    if: ${{ needs.aggregate.outputs.manifest_created == 'true' && inputs.auto_promote != false && inputs.preview_only != true }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: bash
    permissions:
      contents: read
      id-token: write
    env:
      JFROG_URL: ${{ vars.JFROG_URL }}
    steps:
      - name: "[Setup] Checkout"
        uses: actions/checkout@v4

      - name: "[Setup] Checkout bookverse-infra for shared promotion library"
        uses: actions/checkout@v4
        with:
          repository: 'yonatanp-jfrog/bookverse-infra'
          ref: 'main'
          path: 'bookverse-infra'

      - name: "[Setup] Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: "[Setup] Install Python dependencies"
        run: |
          pip install --user PyYAML setuptools wheel
          echo "âœ… Python dependencies installed"

      - name: "[Setup] JFrog CLI"
        uses: EyalDelarea/setup-jfrog-cli@swampUpAppTrust
        id: jfrog-cli-auth-promote
        with:
          oidc-provider-name: bookverse-platform-github
          oidc-audience: ${{ vars.JFROG_URL }}
        env:
          JF_URL: ${{ vars.JFROG_URL }}
          JF_PROJECT: ${{ vars.PROJECT_KEY }}

      - name: "[Setup] Extract OIDC Token from JFrog CLI"
        id: exchange-oidc
        run: |
          echo "ðŸ” Extracting OIDC token from JFrog CLI step output for promotion..."
          
          OIDC_TOKEN="${{ steps.jfrog-cli-auth-promote.outputs.oidc-token }}"
          if [[ -n "$OIDC_TOKEN" && "$OIDC_TOKEN" != "null" ]]; then
            echo "âœ… Successfully retrieved OIDC token from JFrog CLI step output (oidc-token)"
            echo "ðŸ“‹ Token length: ${
          else
            echo "âŒ OIDC token not available from JFrog CLI step output (oidc-token)"
            echo "ðŸ” Available outputs from jfrog-cli-auth-promote step:"
            echo "  oidc-user: '${{ steps.jfrog-cli-auth-promote.outputs.oidc-user }}'"
            echo "  oidc-token: '${{ steps.jfrog-cli-auth-promote.outputs.oidc-token }}'"
            echo "  access-token: '${{ steps.jfrog-cli-auth-promote.outputs.access-token }}'"
            echo "  token: '${{ steps.jfrog-cli-auth-promote.outputs.token }}'"
            exit 1
          fi
          
          echo "token=$OIDC_TOKEN" >> $GITHUB_OUTPUT

      - name: "[Setup] Promotion Environment"
        env:
          APPLICATION_KEY: "bookverse-platform"
          APP_VERSION: "${{ needs.aggregate.outputs.platform_version }}"
          JFROG_URL: "${{ vars.JFROG_URL }}"
          PROJECT_KEY: "${{ vars.PROJECT_KEY }}"
          JF_OIDC_TOKEN: "${{ steps.exchange-oidc.outputs.token }}"
          STAGES_STR: "DEV QA STAGING"
          FINAL_STAGE: "STAGING"
          ALLOW_RELEASE: "false"
        run: |
          echo "ðŸš€ Initializing platform promotion environment..."
          echo "ðŸ“‹ Platform Version: ${{ needs.aggregate.outputs.platform_version }}"
          echo "ðŸŽ¯ Target: DEV â†’ QA â†’ STAGING (PROD handled by separate workflow)"
          
          source bookverse-infra/libraries/bookverse-devops/scripts/evidence-lib.sh
          setup_promotion_environment
          
          echo "âœ… Promotion environment initialized"

      - name: "[Promote & Evidence] DEV Stage"
        env:
          APPLICATION_KEY: "bookverse-platform"
          APP_VERSION: "${{ needs.aggregate.outputs.platform_version }}"
          JFROG_URL: "${{ vars.JFROG_URL }}"
          PROJECT_KEY: "${{ vars.PROJECT_KEY }}"
          JF_OIDC_TOKEN: "${{ steps.exchange-oidc.outputs.token }}"
          STAGES_STR: "DEV QA STAGING"
          FINAL_STAGE: "STAGING"
          ALLOW_RELEASE: "false"
          EVIDENCE_PRIVATE_KEY: ${{ secrets.EVIDENCE_PRIVATE_KEY }}
          EVIDENCE_KEY_ALIAS: ${{ vars.EVIDENCE_KEY_ALIAS }}
          APPTRUST_TIMEOUT_SECONDS: "600"
        run: |
          echo "ðŸ§ª Promoting platform to DEV stage with evidence collection"
          echo "ðŸ“‹ Platform Version: $APP_VERSION"
          echo "ðŸŽ¯ Target Stage: DEV (development environment for platform testing)"
          echo "ðŸ›¡ï¸ Evidence Type: Platform aggregation validation and smoke tests"
          
          if [[ -z "${JF_OIDC_TOKEN:-}" ]]; then
            echo "âŒ Missing JF_OIDC_TOKEN. Ensure OIDC exchange step succeeded." >&2
            exit 1
          fi
          echo "âœ… Using JF_OIDC_TOKEN for DEV promotion"
          
          source bookverse-infra/libraries/bookverse-devops/scripts/evidence-lib.sh
          setup_promotion_environment
          
          if advance_one_step; then
            echo "âœ… Successfully promoted platform to DEV"
          else
            echo "âŒ Failed to promote platform to DEV"
            exit 1
          fi
          
          export APPLICATION_KEY="bookverse-platform"
          export APP_VERSION="${{ needs.aggregate.outputs.platform_version }}"
          attach_application_dev_evidence
          echo "âœ… DEV stage evidence attached via shared library: platform-smoke-tests"

      - name: "[Promote & Evidence] QA Stage"
        env:
          APPLICATION_KEY: "bookverse-platform"
          APP_VERSION: "${{ needs.aggregate.outputs.platform_version }}"
          JFROG_URL: "${{ vars.JFROG_URL }}"
          PROJECT_KEY: "${{ vars.PROJECT_KEY }}"
          JF_OIDC_TOKEN: "${{ steps.exchange-oidc.outputs.token }}"
          STAGES_STR: "DEV QA STAGING"
          FINAL_STAGE: "STAGING"
          ALLOW_RELEASE: "false"
          EVIDENCE_PRIVATE_KEY: ${{ secrets.EVIDENCE_PRIVATE_KEY }}
          EVIDENCE_KEY_ALIAS: ${{ vars.EVIDENCE_KEY_ALIAS }}
          APPTRUST_TIMEOUT_SECONDS: "600"
        run: |
          echo "ðŸ” Promoting platform to QA stage with evidence collection"
          echo "ðŸ“‹ Platform Version: $APP_VERSION"
          echo "ðŸŽ¯ Target Stage: QA (quality assurance for platform integration)"
          echo "ðŸ›¡ï¸ Evidence Type: Platform integration tests and service compatibility validation"
          
          if [[ -z "${JF_OIDC_TOKEN:-}" ]]; then
            echo "âŒ Missing JF_OIDC_TOKEN. Ensure OIDC exchange step succeeded." >&2
            exit 1
          fi
          echo "âœ… Using JF_OIDC_TOKEN for QA promotion"
          
          source bookverse-infra/libraries/bookverse-devops/scripts/evidence-lib.sh
          setup_promotion_environment
          
          if advance_one_step; then
            echo "âœ… Successfully promoted platform to QA"
          else
            echo "âŒ Failed to promote platform to QA"
            exit 1
          fi
          
          export APPLICATION_KEY="bookverse-platform"
          export APP_VERSION="${{ needs.aggregate.outputs.platform_version }}"
          attach_application_qa_evidence
          echo "âœ… QA stage evidence attached via shared library: platform-integration-tests, service-compatibility-scan"

      - name: "[Promote & Evidence] STAGING Stage"
        env:
          APPLICATION_KEY: "bookverse-platform"
          APP_VERSION: "${{ needs.aggregate.outputs.platform_version }}"
          JFROG_URL: "${{ vars.JFROG_URL }}"
          PROJECT_KEY: "${{ vars.PROJECT_KEY }}"
          JF_OIDC_TOKEN: "${{ steps.exchange-oidc.outputs.token }}"
          STAGES_STR: "DEV QA STAGING"
          FINAL_STAGE: "STAGING"
          ALLOW_RELEASE: "false"
          EVIDENCE_PRIVATE_KEY: ${{ secrets.EVIDENCE_PRIVATE_KEY }}
          EVIDENCE_KEY_ALIAS: ${{ vars.EVIDENCE_KEY_ALIAS }}
          APPTRUST_TIMEOUT_SECONDS: "600"
        run: |
          echo "ðŸ—ï¸ Promoting platform to STAGING stage with evidence collection"
          echo "ðŸ“‹ Platform Version: $APP_VERSION"
          echo "ðŸŽ¯ Target Stage: STAGING (pre-production platform validation)"
          echo "ðŸ›¡ï¸ Evidence Type: Platform performance tests and production readiness validation"
          
          if [[ -z "${JF_OIDC_TOKEN:-}" ]]; then
            echo "âŒ Missing JF_OIDC_TOKEN. Ensure OIDC exchange step succeeded." >&2
            exit 1
          fi
          echo "âœ… Using JF_OIDC_TOKEN for STAGING promotion"
          
          source bookverse-infra/libraries/bookverse-devops/scripts/evidence-lib.sh
          setup_promotion_environment
          
          if advance_one_step; then
            echo "âœ… Successfully promoted platform to STAGING"
          else
            echo "âŒ Failed to promote platform to STAGING"
            exit 1
          fi
          
          export APPLICATION_KEY="bookverse-platform"
          export APP_VERSION="${{ needs.aggregate.outputs.platform_version }}"
          attach_application_staging_evidence
          echo "âœ… STAGING stage evidence attached via shared library: platform-performance-test, production-readiness-scan"
          echo "ðŸŽ‰ Platform version $APP_VERSION successfully promoted to STAGING with all evidence!"
          echo "ðŸ”„ Use separate release workflow to promote to PROD when ready"

      - name: "ðŸ“Š Enhanced Platform Summary (bookverse-devops pattern)"
        if: always()
        run: |
          echo "ðŸ“Š Generating comprehensive platform aggregation and promotion summary for stakeholder visibility"
          echo "ðŸŽ¯ This summary provides complete aggregation status, service versions, and deployment readiness"
          
          echo "
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "
          echo "- **Service:** platform (aggregation service)" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform Version:** \`${{ needs.aggregate.outputs.platform_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Type:** Aggregation & Auto-Promotion" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "
          echo "- **Job 1 (aggregate):** âœ… Completed - Service versions collected and platform version created" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.aggregate.outputs.manifest_created }}" == "true" ]]; then
            echo "- **Job 2 (promote):** âœ… Completed - Platform promoted through all stages to STAGING" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Job 2 (promote):** â­ï¸ Skipped (preview mode or creation disabled)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "
          echo "Platform aggregates the following service application versions from PROD stage:" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“¦ Inventory Service:** \`${{ inputs.inventory_version || 'Latest from PROD' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŽ¯ Recommendations Service:** \`${{ inputs.recommendations_version || 'Latest from PROD' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ’³ Checkout Service:** \`${{ inputs.checkout_version || 'Latest from PROD' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŒ Web Service:** \`${{ inputs.web_version || 'Latest from PROD' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ“‹ Platform Manifest:** âœ… Generated with service dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”— Platform Application Version:** âœ… Created in AppTrust with source links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.aggregate.outputs.manifest_created }}" == "true" ]]; then
            echo "
            echo "Platform follows step-by-step promotion with comprehensive evidence collection:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **UNASSIGNED â†’ DEV**: Platform aggregation validation and smoke tests" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **DEV â†’ QA**: Integration tests and service compatibility validation" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **QA â†’ STAGING**: Performance tests and production readiness validation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "
            echo "- **DEV Evidence:** platform-smoke-tests" >> $GITHUB_STEP_SUMMARY
            echo "- **QA Evidence:** platform-integration-tests, service-compatibility-scan" >> $GITHUB_STEP_SUMMARY
            echo "- **STAGING Evidence:** platform-performance-test, production-readiness-scan" >> $GITHUB_STEP_SUMMARY
            echo "- **Evidence Collection:** âœ… Cryptographically signed and uploaded" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "
          echo "- **bookverse-devops:** âœ… Shared OIDC authentication & promotion patterns" >> $GITHUB_STEP_SUMMARY
          echo "- **Service Aggregation:** âœ… Automated collection from PROD stage releases" >> $GITHUB_STEP_SUMMARY
          echo "- **Step-by-step Promotion:** âœ… Individual stage promotion with evidence" >> $GITHUB_STEP_SUMMARY
          echo "- **Compliance Evidence:** âœ… Comprehensive audit trail for each stage" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform-specific Logic:** âœ… Custom aggregation without package versioning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.aggregate.outputs.manifest_created }}" == "true" ]]; then
            echo "
            echo "Platform version **\`${{ needs.aggregate.outputs.platform_version }}\`** has been created and promoted to **STAGING**." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ”„ Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- Platform is ready for STAGING validation and testing" >> $GITHUB_STEP_SUMMARY
            echo "- Use separate **Release** workflow to promote to PROD when ready" >> $GITHUB_STEP_SUMMARY
            echo "- PROD promotion requires manual approval and additional compliance validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "
            echo "Platform aggregation ran in preview mode - no versions created or promoted." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ”„ Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- Run workflow with \`create_version=true\` to create platform application version" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure \`auto_promote=true\` to enable automatic promotion to STAGING" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Enhanced platform summary generated using bookverse-devops patterns" >> $GITHUB_STEP_SUMMARY
